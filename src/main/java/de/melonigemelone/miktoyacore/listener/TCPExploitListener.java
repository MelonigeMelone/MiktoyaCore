package de.melonigemelone.miktoyacore.listener;

import de.melonigemelone.miktoyaapi.MiktoyaAPI;
import de.melonigemelone.miktoyaapi.api.tcpexploitfixer.mysql.TCPExploitFixerMySQL;
import org.bukkit.Bukkit;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerLoginEvent;
import org.bukkit.event.player.PlayerQuitEvent;

public class TCPExploitListener implements Listener {

    @EventHandler
    public void onJoin(PlayerLoginEvent e) {
        Player p = e.getPlayer();
        String uuid = p.getUniqueId().toString();
        TCPExploitFixerMySQL tcpExploitFixerMySQL = MiktoyaAPI.getTcpExploitFixerMySQL();

        tcpExploitFixerMySQL.existsUUID(uuid, resultUUID ->  {
            tcpExploitFixerMySQL.existsConnection(uuid, resultConnection -> {

                if((!resultUUID) || resultConnection) {

                    Bukkit.getScheduler().runTask(MiktoyaAPI.getInstance(), new Runnable() {
                        @Override
                        public void run() {
                            p.kickPlayer("Could not check your Connection, please retry it !");
                        }
                    });

                } else {
                    tcpExploitFixerMySQL.addConnection(e.getPlayer().getUniqueId().toString());
                }
            });
        });
    }

    @EventHandler
    public void onQuit(PlayerQuitEvent e) {
        MiktoyaAPI.getTcpExploitFixerMySQL().delConnection(e.getPlayer().getUniqueId().toString());
    }
}
